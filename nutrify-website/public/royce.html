<html>

<head>
    <title>Nutrify</title>
    <style>
        #list {
            width: 40%;
            position: relative;
            height: 300px;
            background-color: lightgrey;
            overflow: scroll;
        }
        #array {
            width: 40%;
            position: relative;
            height: 300px;
            background-color: green;
            overflow: scroll;
            display: none;
        }
        .inner {
            width: 100%;
            position: relative;
            height: 20%;
            background-color: white;
        }
        #ml {
            position: fixed; 
            top: 20%; 
            left: 20%; 
            width: 60%;
            height: 60%;
            display: none;
            background-color: white;
            border: 3px solid red;
        }
  </style>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Yay</title>
  <link href="style.css" rel="stylesheet" type="text/css" />
   <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src='https://www.gstatic.com/firebasejs/7.15.5/firebase.js'></script>
    <script src="script.js"></script>
</head>
<body>
    <h1> Search Option </h1>
    <br>
    <label>Search:</label>
<input type="text" id="food" oninput="trueA()"><br></input>
  <!-- Css tbd-->
<div id="list"></div>
    <h1> Scan image </h1>
    <div id="console"></div>
<video autoplay playsinline muted id="webcam" width="224" height="224"></video>
<div id="ml"> <h1 id="top">Alas! I think it's <label id="name"></label>. </h1><div id="entOp"><button onclick="assemble()"> That's right </button> <br><button>Not it </button></div><div id="array"></div></div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script>
    var indArray;
var test = db.collection('temporaryCollection').doc('temporaryDocument');
var nutrientIds = [1005, 1293, 1003, 1258, 1079, 2000, 1062, 1087, 1099, 1089, 1090, 1101, 1091, 1092, 1103, 1093, 1095, 1120, 1123, 1122, 1180, 1177, 1167, 1170, 1166, 1104, 1175, 1178, 1162, 1110, 1109, 1185, 1057, 1253, 1104, 1213];
var nutrientUnits = ["G","G","G","G","G","G","KCAL","G","G","G","G","G","G","G","G","G","G","G","G","G","G","G","G","G","G","IU","G","G","G","IU","G","G","G","G","G","G"];
function trueA() {
  var valInput = document.getElementById("food").value;
  if(typeof valInput !== "undefined") {
      var entity = "";
      for(let j=0; j<valInput.length; j++) {
          if(valInput[j] == " ") {
              entity += "%20"; 
          } else {
              entity += valInput[j];
          }
      }
      if(entity=="") {
          entity = "food";
      }
      fetch('https://api.nal.usda.gov/fdc/v1/foods/search?api_key=3gxUJxixMLQ0VcnleWLIzaXbkjU3a7CgwbU34cvM&query=' + entity)
      .then(res => res.json())
      .then((out) => {
          hey(out);
      }).catch(err => console.error(err));
  }
}
function hey(out) {
  var total;
  if(out.foods.length != 0) {
      document.getElementById("list").innerHTML = "";
  }
  for(let i=0; i<=out.foods.length; i++) {
      var owner = out.foods[i].brandOwner;
      if (typeof owner === "undefined") {
           owner = "";
      } else {
           owner = " | " + out.foods[i].brandOwner;
      }
      var button = document.createElement("button");
      button.innerHTML = out.foods[i].description + owner;
      button.className = "inner";
      total = out.foods[i].description + owner;
      button.onclick = function() {
          //grab nutrients and send them to database
          addentFlow(out, i);
      };
      var list = document.getElementById("list");
      list.appendChild(button);
  }
}

function addentFlow(out, i) {
    var nutrientVal;
    console.log(out.foods[i].foodNutrients);
    //grab specific nutrients
    for(let t=0; t<out.foods[i].foodNutrients.length; t++) {
        for(let z=0; z<nutrientIds.length; z++) {
            if(out.foods[i].foodNutrients[t].nutrientId == nutrientIds[z]) {
                //convert units to that in the array of nutrientUnits
                if(out.foods[i].foodNutrients[t].unitName == nutrientUnits[z]) {
                    nutrientVal = out.foods[i].foodNutrients[t].value;
                } else if(out.foods[i].foodNutrients[t].unitName == "MG") {  //milligram
                    nutrientVal = out.foods[i].foodNutrients[t].value / 1000;
                } else if(out.foods[i].foodNutrients[t].unitName == "UG") {  //microgram
                    nutrientVal = out.foods[i].foodNutrients[t].value / 1000000;
                } else { //kJ to KCAL converter
                    nutrientVal = out.foods[i].foodNutrients[t].value / 4.184;
                }

                //update data in the database
                test.update({
                   //find a way to update the nutrientsArray
                })
            }
        }
    }
        //add food name to database
       //TBD function
}


const webcamElement = document.getElementById('webcam');
let net;
let constant;
let happy = true;
let limit;
async function app() {
net = await mobilenet.load();
const webcamConfig = {facingMode: 'environment'};
const webcam = await tf.data.webcam(webcamElement, webcamConfig);
let time = 0;
var complete;
while (happy) {
  time++;
  const img = await webcam.capture();
  const result = await net.classify(img);

  fetch('https://api.nal.usda.gov/fdc/v1/foods/search?api_key=3gxUJxixMLQ0VcnleWLIzaXbkjU3a7CgwbU34cvM&query=' + `${result[0].className}`)
      .then(res => res.json())
      .then((ses) => {
          limit = ses;
          happy = false;
          //remove the top after := only for debugging purposes
          if(`${result[0].probability}` > 0.4) { //check distinct probability
              for(let m=0; m<ses.foods.length; m++) {
                  if(ses.foods[m].description.includes(`${result[0].className}`) == true) {
                      happy = false;
                      document.getElementById("ml").style.display = "block";
                      vowels = ["a", "e", "i", "o", "u"];
                      for(let a=0; a<5; a++) {
                          if(`${result[0].className}`[0] == vowels[a]) {
                              complete = "an ";
                          }
                      }
                      if(typeof complete === "undefined") {
                          complete = "a ";
                      }
                      document.getElementById("name").innerHTML = complete + `${result[0].className}` ;
                  }
              }
          }

      }).catch(err => console.error(err));
  img.dispose();
  setTimeout(function(){
      //pause := don't make messy for client
  }, 2000);
  await tf.nextFrame();
}
}

app();

function assemble() {
  document.getElementById("top").innerHTML = "Select Correct Item:";
  document.getElementById("entOp").style.display = "none";
  document.getElementById("array").style.display = "block";

  var totalIt;
  if(limit.foods.length != 0) {
      document.getElementById("list").innerHTML = "";
  }
  for(let i=0; i<=limit.foods.length; i++) {
      var ownerB = limit.foods[i].brandOwner;
      if (typeof ownerB === "undefined") {
           ownerB = "";
      } else {
           ownerB = " | " + limit.foods[i].brandOwner;
      }
      var buttonB = document.createElement("button");
      buttonB.innerHTML = limit.foods[i].description + ownerB;
      buttonB.className = "inner";
      totalIt = limit.foods[i].description + ownerB;
      buttonB.onclick = function() {
          console.log(limit.foods[i]);
      };
      var array = document.getElementById("array");
      array.appendChild(buttonB);
  }
}

    function setBasic() {
        var truth;
        db.collection('temporaryCollection').doc('temporaryDocument').get().then(function(doc) { 
            truth = doc.data().calendar.length;
        })
        if(typeof truth === "undefined") {
            truth = 0;
        }
        indArray = truth;

        var mop = new Date();
        var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        let today = mop.getDate() + "/" + months[mop.getMonth()] + "/" + mop.getFullYear();

        test.update({
            calendar: firebase.firestore.FieldValue.arrayUnion({
                dayName: today,
                foodArray: [],
                nutrientsArray: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            })
        })
    }

    window.onload = function() {
        db.collection('temporaryCollection').doc('temporaryDocument').get().then(function(doc) { 
            var mop1 = new Date();
            var months1 = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            let today1 = mop1.getDate() + "/" + months1[mop1.getMonth()] + "/" + mop1.getFullYear();
            let cure = true;
            for(let c=0; c<doc.data().calendar.length; c++) {
                if(doc.data().calendar[c].dayName == today1) {
                    cure = false;
                    indArray = c;
                } 
            }
            if(cure == true) {
                setBasic();
            }
        }).catch(function (e) {
            //nothing in file move on to the setBasic function()
            setBasic();
            console.log(e);
        })
    }
</script>
</body>
</html>
